<?php
/** @var Tiles $block */

use GardenLawn\MediaGallery\Block\Adminhtml\Gallery\Tiles;

?>
<div id="gallery-tile-component" class="gallery-tiles-container" data-mage-init='{"galleryTileComponent": <?= /* @noEscape */ $block->getJsConfig() ?>}'>

    <div class="gallery-toolbar">
        <div class="gallery-search">
            <input type="text" id="gallery-search-input" class="admin__control-text" placeholder="<?= $block->escapeHtmlAttr(__('Search by path...')) ?>"/>
        </div>
        <div class="gallery-actions">
            <button id="add-new-gallery-button" class="action-primary">
                <?= $block->escapeHtml(__('Add New Gallery')) ?>
            </button>
        </div>
    </div>

    <div id="gallery-tiles-grid" class="gallery-tiles-grid">
        <?php foreach ($block->getGalleriesData() as $gallery): ?>
            <div class="gallery-tile"
                 data-id="<?= $block->escapeHtmlAttr($gallery['id']) ?>"
                 data-path="<?= $block->escapeHtmlAttr($gallery['path']) ?>"
                 data-enabled="<?= (int)$gallery['enabled'] ?>">

                <div class="drag-handle" title="<?= $block->escapeHtmlAttr(__('Drag to reorder')) ?>"></div>

                <div class="tile-status-indicator" title="<?= $gallery['enabled'] ? $block->escapeHtmlAttr(__('Enabled')) : $block->escapeHtmlAttr(__('Disabled')) ?>"></div>

                <div class="tile-asset-count" title="<?= $block->escapeHtmlAttr(__('%1 assets', $gallery['asset_count'])) ?>">
                    <?= $block->escapeHtml($gallery['asset_count']) ?>
                </div>

                <div class="tile-actions-toggle" title="<?= $block->escapeHtmlAttr(__('Actions')) ?>"></div>
                <div class="tile-actions-dropdown">
                    <a href="#" class="action-toggle-status">
                        <span><?= $gallery['enabled'] ? $block->escapeHtml(__('Disable')) : $block->escapeHtml(__('Enable')) ?></span>
                    </a>
                    <a href="<?= $block->escapeUrl($gallery['edit_url']) ?>">
                        <span><?= $block->escapeHtml(__('Edit')) ?></span>
                    </a>
                    <a href="#" class="action-delete">
                        <span><?= $block->escapeHtml(__('Delete')) ?></span>
                    </a>
                </div>

                <a href="<?= $block->escapeUrl($gallery['edit_url']) ?>" class="tile-link">
                    <div class="tile-image-wrapper">
                        <img src="<?= $block->escapeUrl($gallery['thumbnail']) ?>" alt="<?= $block->escapeHtmlAttr($gallery['name']) ?>" loading="lazy" />
                    </div>
                    <div class="tile-info">
                        <span class="tile-name"><?= $block->escapeHtml($gallery['name']) ?></span>
                    </div>
                </a>
            </div>
        <?php endforeach; ?>
        <div id="no-results-message" class="no-results-message" style="display: none;">
            <?= $block->escapeHtml(__('No galleries found.')) ?>
        </div>
    </div>
</div>

<script>
    require(['jquery'], function($) {
        let currentFilterPath = '';

        // Listen for the tree filter update and store the path
        $('body').on('gallery:filter:update', function(e, filterValue) {
            currentFilterPath = filterValue;
        });

        // Attach a click handler to the new gallery button
        $('#add-new-gallery-button').on('click', function() {
            let baseUrl = '<?= $block->escapeUrl($block->getAddNewGalleryUrl()) ?>';
            let finalUrl = baseUrl;

            if (currentFilterPath) {
                // Append the path, Base64 encoded to handle slashes safely
                finalUrl += 'path/' + btoa(currentFilterPath) + '/';
            }

            window.location.href = finalUrl;
        });
    });
</script>
